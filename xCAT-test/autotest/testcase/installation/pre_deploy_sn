#!/usr/bin/env perl

my $os=$ARGV[0];
my $arch=$ARGV[1];
my $log="/tmp/pre_deploy_sn.log";

sub runcmd{
    my $cmd=shift;
    `$cmd >> $log 2>&1`;
    if($?){
        #print "run $cmd ....[error]\n";
        exit 1;
    }
}

my $setupmysqlscript="#!/usr/bin/expect -f
set timeout -1
spawn mysqlsetup -i
expect \"in the MySQL database:\"
send \"12345\\r\"
expect \"in the MySQL database:\"
send \"12345\\r\"
interact
";

my $cmd = "echo '$setupmysqlscript' > /tmp/setupmysqlscript && chmod +x /tmp/setupmysqlscript";
runcmd("$cmd");

$cmd="bash -lic \"/tmp/setupmysqlscript > /tmp/setupmysqlscript.rst\" ";
runcmd("$cmd");

$cmd="echo \"GRANT ALL on xcatdb.* TO xcatadmin@\'%\'  IDENTIFIED BY \'12345\'\;\" | mysql -u root -p12345";
runcmd("$cmd");

my $xcatballpath = "/install/post/otherpkgs/$os/$arch/xcat";
$cmd="mkdir -p $xcatballpath/xcat-core && cp -r /xcat-core/* $xcatballpath/xcat-core && cp -r /xcat-dep $xcatballpath";
runcmd("$cmd");

exit 0;
